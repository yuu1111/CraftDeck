# Minecraft & StreamDeck 連携システム仕様書

## 1\. 概要

本プロジェクトは、Minecraft のゲーム内情報を StreamDeck にリアルタイム表示し、StreamDeck のボタン操作を通じて Minecraft の特定コマンドを実行できるシステムを構築することを目的とします。これにより、プレイヤーはより直感的かつ効率的にゲームを操作できるようになります。

-----

## 2\. 目標

  * **Minecraft の主要なゲーム内情報を StreamDeck に分かりやすく表示する。**
  * **StreamDeck のボタンから定義済みの Minecraft コマンドを実行可能にする。**
  * シングルプレイヤー、および Mod 導入が許可されたマルチプレイヤー環境下で、**各プレイヤーのクライアントサイドで完結するソリューションを提供する。**
  * 将来的に**他の Minecraft Mod と連携可能な API を提供する。**
  * 将来的に**サーバーサイド機能（サーバー監視・管理）への拡張を可能にする。**

-----

## 3\. 技術スタック

### 3.1. Minecraft Mod

  * **言語**: Kotlin
  * **Mod ローダーフレームワーク**: Architectury
      * **対応ローダー**: Fabric API, Forge API
  * **通信ライブラリ**: Kotlin/Java 標準の WebSocket ライブラリ

### 3.2. StreamDeck Plugin

  * **言語**: C# (.NET)
      * **C# (.NET)**: StreamDeck SDKとの直接的なインターフェース、WebSocket通信、JSONデータのパース、ボタン描画、Property Inspector（設定画面）の実装など、プラグインのすべてのロジックを担当します。
  * **通信ライブラリ**: .NET 標準の WebSocket クライアント (`System.Net.WebSockets.ClientWebSocket`)

### 3.3. 通信プロトコル

  * **形式**: WebSocket (JSON 形式)
  * **データフォーマット**: JSON
  * **通信方向**: 双方向通信
  * **データ量**: ローカル環境での動作が主であるため、アイコンなどのデータ量によるコストは許容します。

-----

## 4\. 機能要件

### 4.1. Minecraft Mod (送信機能)

Mod は WebSocket サーバーとして機能し、以下のゲーム内情報を StreamDeck プラグインに送信します。

1.  **プレイヤーの基本ステータス (`player_status`)**:
      * ヘルス (`health`, `max_health`), 空腹度 (`food`, `saturation`)
      * 経験値 (`experience.level`, `experience.progress`)
      * 座標 (`coords.x`, `coords.y`, `coords.z`, `coords.display_string`)
      * ディメンション (`dimension.id`, `dimension.name`)
      * バイオーム (`biome.id`, `biome.name`)
      * プレイヤーの状態 (`is_sprinting`, `is_sneaking`, `is_on_ground`)
      * ゲームモード (`gamemode.id`, `gamemode.name`)
      * **送信トリガー**: ティックイベントベースの定期更新（例: 0.5秒〜1秒ごと）、または値に変化があった場合。
2.  **ゲーム内の時間と天候 (`world_status`)**:
      * ゲーム内時間 (`game_time`, `day_time_string`)
      * 天候 (`is_raining`, `is_thundering`, `weather_name`)
      * **送信トリガー**: ティックイベントベースの定期更新、または天候変化時。
3.  **所持アイテム情報 (`inventory_slot`)**:
      * スロットタイプ (`slot_type`), スロットインデックス (`slot_index`)
      * アイテム ID (`item_id`), 表示名 (`display_name`), スタック数 (`count`)
      * 耐久度 (`durability.current`, `durability.max`, `durability.percentage`)
      * エンチャント (`enchantments`: ID, level)
      * カスタム名 (`has_custom_name`)
      * **アイテムアイコン (Base64 PNG)**: `item_icon_base64_png`
      * **送信トリガー**: インベントリ変更イベント発生時、またはアイテムの耐久度変化時。
4.  **ポーション効果リスト (`potion_effect_list`)**:
      * 効果 ID (`effect_id`), 表示名 (`effect_name`), 増幅レベル (`amplifier`)
      * 残り時間 (`duration_ticks`, `duration_string`)
      * その他の状態 (`is_ambient`, `show_particles`)
      * **効果アイコン (Base64 PNG)**: `icon_base64_png`
      * **送信トリガー**: ポーション効果の付与/終了/時間更新イベント時。

### 4.2. StreamDeck Plugin (受信・表示・送信機能)

プラグインは WebSocket クライアントとして機能し、Mod からの情報を受信して StreamDeck に表示し、ボタン操作を Mod に送信します。

#### 4.2.1. 情報の表示機能

  * **テキスト表示**: 受信したデータに基づき、設定されたテンプレート文字列（例: `HP: {health}/{max_health}`）に従ってテキストを表示します。フォントサイズ、色、配置の調整を可能にします。
  * **ゲージ/バー表示**: ヘルス、空腹度、アイテム耐久度などをプログレスバー形式で表示します。色、背景色、方向を設定可能にします。
  * **アイコン表示**: Mod から送信された Base64 PNG 画像をデコードし、ボタン上に表示します。条件に応じたアイコン切り替え（例: ヘルスが低いときにドクロアイコン）を可能にします。
  * **UI 更新**: WebSocket で情報を受信するたびに、関連する StreamDeck ボタンの表示を更新します。

#### 4.2.2. コマンド実行機能

  * **コマンド送信**: ボタンが押下された際に、Property Inspector で設定された Minecraft コマンド文字列を Mod に送信します。
  * **コマンド実行後のフィードバック**: オプションで、コマンド実行成功時に一時的にボタンのアイコンを変更する（例: チェックマーク）。
  * **実行前の確認**: 破壊的なコマンドの場合、確認ダイアログを表示するオプションを提供します。

#### 4.2.3. WebSocket 接続管理

  * **自動接続/再接続**: プラグイン起動時に Mod への自動接続を試み、切断時には一定間隔で再接続を試みます。
  * **接続状態表示**: StreamDeck のボタン上で現在の接続状態（例: "Waiting for Minecraft...", "Connected"）を表示します。

### 4.3. 共通機能

  * **初期接続時のフル送信**: StreamDeck プラグインが Mod に接続を確立した際、Mod は現在のゲーム状態の全情報を一度送信します。

-----

## 5\. UI/UX (Property Inspector) 設計

StreamDeck の Property Inspector は、ユーザーが各ボタンのアクションと表示を詳細に設定できるインターフェースを提供します。

### 5.1. グローバル設定 (プラグイン全体)

  * **Minecraft Mod 接続設定**:
      * **IPアドレス/ホスト名**: `localhost` をデフォルトとしますが、必要に応じて変更可能にします。
      * **ポート番号**: デフォルトポートを設定し、競合回避のため変更可能にします。
      * **接続テストボタン**: 現在の設定での接続テスト機能を提供します。
  * **自動接続/再接続設定**: 自動接続を行うかどうかのチェックボックス、再接続を試みる間隔（秒）の設定。

### 5.2. 各ボタンアクション設定

まず、そのボタンがどのような機能を持つのかを選択させます。ドロップダウンリストで選択できるようにするのが一般的です。

  * **情報表示**: Minecraft からのゲーム内情報を表示するボタン。
  * **コマンド実行**: Minecraft コマンドを実行するボタン。
  * **状態切り替え**: 特定の状態（例: 時間帯）を切り替えるボタン (「コマンド実行」の特殊ケースとして実装することも可能)。
  * **カスタム**: 他の Mod が API 経由で定義するカスタムアクション（これは後から追加する高度な機能）。

#### 5.2.1. 「情報表示」アクションの設定

選択したアクションタイプに応じて、異なる設定項目を表示します。

  * **表示したい情報の種類**: ドロップダウンリストで選択（例: `プレイヤーヘルス`, `プレイヤー座標`, `ゲーム内時間`, `インベントリスロット`, `天候`, `ポーション効果` など）。
      * **もし「インベントリスロット」を選択した場合**:
          * **スロットタイプ**: `メインハンド`, `オフハンド`, `防具 (頭/体/脚/足)`, `インベントリ` (特定のインベントリスロットを表示する場合) から選択。
          * **スロット番号**: `インベントリ`を選んだ場合に表示 (0-35など) される数値入力フィールド。
          * **表示内容**: (チェックボックスまたはドロップダウン) `アイテム名`, `アイテムアイコン`, `スタック数`, `耐久度バー`, `エンチャント/NBTデータ` (詳細表示オプション)。
      * **もし「ポーション効果」を選択した場合**:
          * **効果の種類**: ドロップダウンで選択（例: `Strength`, `Speed`, `Jump Boost` など）。
          * **表示内容**: `アイコン`, `効果レベル`, `残り時間`。
  * **表示フォーマット (テキスト)**:
      * テンプレート文字列入力フィールド（例: `"HP: {health}/{max_health}"`、`"Time: {day_time_string}"`）。
      * 利用可能なプレースホルダーのリスト表示。
      * フォントサイズ、色、配置の調整オプション。
  * **表示フォーマット (グラフィック)**:
      * **ゲージ/バー表示**: `ヘルスバー`, `空腹度バー`, `耐久度バー` の種類を選択。色、背景色、バーの方向（水平/垂直）を設定。
      * **アイコン表示**: 条件に応じてアイコンを切り替える設定 (例: ヘルスが低いときにドクロアイコンを表示)。
  * **更新頻度**: (オプション) このボタンの情報を特に頻繁に更新するか、あるいはイベントドリブンでの更新に限定するかを設定。

#### 5.2.2. 「コマンド実行」アクションの設定

  * **実行するコマンド**: テキストエリアまたは入力フィールド。
      * 例: `/gamemode creative`, `/time set day`, `/give @p diamond 64`。
      * 引数入力補助（オプションだが非常に便利）：例えば `/give` と入力したら「@p, アイテムID, 数量」のようなガイドを表示する。
  * **コマンド実行後のフィードバック**: 実行成功時に一時的にボタンのアイコンを変更する（例: チェックマーク）オプション。
  * **実行前の確認**: (チェックボックス) ボタンを押したときに確認ダイアログを表示するか（特に破壊的なコマンドの場合）。

### 5.3. その他の便利な機能

  * **プロファイル切り替えアクション**: Minecraft Mod 連携プロファイルに自動で切り替えるボタンアクション。
  * **カスタムアイコン設定**: 各ボタンに表示するカスタムアイコン（画像ファイル）を設定できるようにします。
  * **プリセット/テンプレート**: よく使う設定の組み合わせを保存・ロードできる機能。

-----

## 6\. データフローとイベントトリガー

### 6.1. Mod → Plugin (ゲーム内情報の通知)

Mod は、以下のイベントトリガーに基づいてゲーム内情報を WebSocket で送信します。

  * **ティックイベントベースの定期更新**: プレイヤーのヘルス、空腹度、座標、現在の時間、天候など、頻繁に変動する可能性のある情報を、ティックごとに変化をチェックし、変化があった場合または設定された時間間隔（例: 0.5秒〜1秒ごと）が経過した場合に送信します。
  * **イベント駆動の更新**: インベントリの変更、アイテムの耐久度の変化、ポーション効果の付与/終了、実績の解除など、特定の Minecraft イベントが発生した直後に送信します。
  * **初期接続時のフル送信**: StreamDeck Plugin が WebSocket 接続を確立した直後、初期表示に必要な全ての情報を一括で送信します。

### 6.2. Plugin → Mod (コマンド実行要求)

StreamDeck Plugin は、ユーザーのボタン操作に応じて、Minecraft Mod へコマンド実行を要求します。

  * **トリガー**: StreamDeck のボタンが押下された時。
  * **フロー**: Plugin がボタンに紐付けられたコマンド文字列を JSON 形式 (`{"type": "execute_command", "command": "..."}`) に整形し、Mod サーバーへ送信します。Mod からの成功/失敗レスポンスを受け取り、StreamDeck 上でフィードバックを行うことも検討します。

### 6.3. WebSocket 接続管理

  * **Mod 側 (サーバー)**: 起動時に指定ポートで WebSocket サーバーを起動し、Plugin からの接続を待機します。Mod 終了時にサーバーを適切にシャットダウンします。
  * **Plugin 側 (クライアント)**: 起動時に Mod サーバーへの接続を試み、接続に失敗した場合や切断された場合、一定の間隔で再接続を試みます。再接続中は StreamDeck のボタンに「Not Connected」などの状態を表示します。

-----

## 7\. JSON スキーマ詳細

(本仕様書では、上記「4.1. Minecraft Mod (送信機能)」に記載された JSON 構造を具体的なスキーマとして採用します。以下は例として一部を再掲しますが、詳細は機能要件セクションを参照ください。)

### 7.1. Mod → Plugin (情報送信) 例

#### 7.1.1. プレイヤーの基本ステータス (`player_status`)

```json
{
  "type": "player_status",
  "data": {
    "health": 20.0,
    "max_health": 20.0,
    "food": 20,
    "saturation": 5.0,
    "experience": {
      "level": 15,
      "progress": 0.75
    },
    "coords": {
      "x": 123.45,
      "y": 64.0,
      "z": -789.01,
      "display_string": "X:123 Y:64 Z:-789"
    },
    "dimension": {
      "id": "minecraft:overworld",
      "name": "Overworld"
    },
    "biome": {
      "id": "minecraft:plains",
      "name": "Plains"
    },
    "is_sprinting": true,
    "is_sneaking": false,
    "is_on_ground": true,
    "gamemode": {
      "id": "survival",
      "name": "Survival"
    }
  }
}
```

#### 7.1.2. 所持アイテム (`inventory_slot`)

```json
{
  "type": "inventory_slot",
  "data": {
    "slot_type": "mainhand",
    "slot_index": 0,
    "item_id": "minecraft:diamond_pickaxe",
    "display_name": "Diamond Pickaxe",
    "count": 1,
    "durability": {
      "current": 1234,
      "max": 1561,
      "percentage": 0.79
    },
    "enchantments": [
      {"id": "minecraft:unbreaking", "level": 3}
    ],
    "has_custom_name": false,
    "item_icon_base64_png": "iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8...",
    "nbt": {}
  }
}
```

### 7.2. Plugin → Mod (コマンド実行)

```json
{
  "type": "execute_command",
  "command": "gamemode creative",
  "source": "streamdeck_plugin"
}
```

-----

## 8\. 開発ロードマップ (フェーズ別)

### フェーズ 1: MVP (Minimum Viable Product) の開発と完成

1.  **開発環境のセットアップ**: Architectury + Kotlin (Mod) および C\# (.NET) + Kotlin (JVM) (Plugin) の開発環境をセットアップ。
2.  **WebSocket 通信の確立**: Mod 側の WebSocket サーバーと Plugin 側の WebSocket クライアントの最小限の実装。
3.  **最初のデータ連携**: Mod から**プレイヤーのヘルス情報**を取得し、Plugin へ送信、StreamDeck にテキスト表示。
4.  **最初のコマンド実行**: StreamDeck ボタンから**簡単な Minecraft コマンド**を Mod へ送信し、実行。
5.  **接続管理とフィードバック**: WebSocket 接続状態の表示、Plugin 側の再接続ロジックを実装。

### フェーズ 2: クライアントサイド機能の拡張と洗練

1.  **JSON スキーマの全実装**: 策定した全ての JSON スキーマに対応する Mod 側のデータ取得と送信ロジックを実装。
2.  **StreamDeck Plugin UI/UX の充実**: Property Inspector での情報表示/コマンド実行設定、アイコン/ゲージ表示機能の実装。
3.  **イベント駆動のデータ更新**: インベントリ変更など、イベント発生時にのみ情報を送信する Mod 側のロジックを実装。
4.  **堅牢性の向上**: エラーハンドリング、ポート競合時の対応、詳細なロギングを実装。

### フェーズ 3: Mod 間連携 API の提供

1.  **公共 API の実装**: 他の Mod がこの Mod の機能を利用できるよう、Kotlin/Architectury で公開 API インターフェースと実装を提供。
2.  **ドキュメントの作成**: 他の Mod 開発者向けに、API の詳細な使用方法に関するドキュメントを作成。

### フェーズ 4: サーバーサイド対応の検討と実装 (将来的な拡張)

1.  **要件定義の再検討**: サーバー管理者向けの具体的な機能（サーバーパフォーマンス監視、プレイヤー管理、ログ監視など）を定義。
2.  **Mod のサーバーサイド対応**: Mod をサーバーサイドでも動作するように実装を調整。サーバーからの情報取得とサーバーコマンド実行のロジックを実装。
3.  **セキュリティと認証**: WebSocket 通信のセキュリティ（TLS/SSL、API キーなど）を強化。Plugin 側での認証情報管理と送信ロジックを実装。
4.  **Plugin の UI/UX 調整**: サーバーサイドの機能に対応した StreamDeck Property Inspector の UI を追加。